// Moodle Database Activity Javascript Template Function
// Name: validate
// Description: Simply validates a URL by checking to see
// if it falls within expected URL standard formatting

function validate(url) {
    var pattern = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;
    // Compare the URL with the pattern
    if (pattern.test(url)) {
        // Valid URL
        return true;
    }
    // Not a valid URL
    return false;
}

// Moodle Database Activity Javascript Template Function
// Name: formatPostLinks
// Description: This script formats Moodle DB URL fields
// and turns them into a link using another Moodle DB field
// as the URL title. It also shortens the length of the URL title
// so it fits on one line in a table.

function formatPostLinks() {
     // Loop through all the post titles and replace with links.
     var titles = document.getElementsByClassName('postTitle');
     var links = document.getElementsByClassName('postLink');

     var shortenstring = '';
     var linked_title = '';
     var valid_link = '';
     var secure_link = '';
     for (var i = 0; i < titles.length; i++) {
        linked_title = '<a target="_blank" rel="noreferrer" href="';
        // Grab the URL
        alinks = links[i].getElementsByTagName('a');
        for (var j = 0; j < alinks.length; j++) {
            secure_link = alinks[j].href;
            secure_link = secure_link.replace("http:", "https:");
            // Make sure the link is a valid URL
            if (!validate(secure_link)) {
                valid_link = ' <-- Link is NOT valid';
            }
            linked_title += secure_link;
         }

         // Shorten the post title a bit if needed
         var linkstring = titles[i].innerHTML;
         if (linkstring.length > 45) {
            linkstring = linkstring.substring(0, 45) + '...';
         }
         links[i].innerHTML = '';
         linked_title += '"><b><i>"<u>' + linkstring + '</u>"</i></b></a>';
         linked_title += valid_link; // Add the warning if the link is not valid
         // Replace the title with the linked title
         titles[i].innerHTML = linked_title;
     }
}

// Moodle Database Activity Javascript Template Function
// Name: formatPostLinksAndEmbed
// Description: This script does the same things as formatPostLinks
// script but also creates an embed item for the entire URL.
// Note: Moodle requires HTTPS links to embed.

function formatPostLinksAndEmbed() {
    var titles = document.getElementsByClassName('postTitle');
    var links = document.getElementsByClassName('postLink');
    var embedded_posts = document.getElementsByClassName('embedPost');

    var linked_title = '';
    var valid_link = '';
    var secure_link = '';
    var embed_line = '';

    for (var i = 0; i < titles.length; i++) {
        linked_title = '<a target="_blank" rel="noreferrer" href="';
        embed_line = '<embed width="100%" height="475px" src="';
        alinks = links[i].getElementsByTagName('a');
        for (var j = 0; j < alinks.length; j++) {
            secure_link = alinks[j].href;
            secure_link = secure_link.replace("http:", "https:");
            if (!validate(secure_link)) {
                valid_link = ' <-- Link is NOT valid';
            }
            linked_title += secure_link;
            embed_line += secure_link;
        }
        // Finish making the linked title
        links[i].innerHTML = '';
        linked_title += '"><b><i>"<u>' + titles[i].innerHTML + '</u>"</i></b></a>';
        linked_title += valid_link;
        titles[i].innerHTML = linked_title;
        // Finish making the embed object
        embed_line += '">';
        embed_line += '<br><b>Link:</b> ';
        embed_line += secure_link;
        embedded_posts[i].innerHTML = embed_line;
     }
}
